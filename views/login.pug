extends layout

block scripts
  script(src="/js/validation.js", defer)

block content
  .login-container
    h1 El Lector Voraz
    
    .login-illustration
      //- Subtle book icon with new color palette
      svg(width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg")
        path(d="M4 19.5C4 18.837 4.26339 18.2011 4.73223 17.7322C5.20107 17.2634 5.83696 17 6.5 17H20" stroke="#8C442A" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" stroke-opacity="0.9")
        path(d="M6.5 2H20V22H6.5C5.83696 22 5.20107 21.7366 4.73223 21.2678C4.26339 20.7989 4 20.163 4 19.5V4.5C4 3.83696 4.26339 3.20107 4.73223 2.73223C5.20107 2.26339 5.83696 2 6.5 2Z" stroke="#8C442A" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" stroke-opacity="0.9")

    h2.login-subtitle Iniciar sesión

    if error
      .message.error= error

    form#login-form(action="/api/auth/login" method="POST" novalidate)
      .form-group
        label(for="email") Email:
        input#email(type="email" name="email" required aria-required="true" placeholder="tu@email.com")
      
      .form-group
        label(for="password") Contraseña:
        input#password(type="password" name="password" required aria-required="true" placeholder="••••••••")
      
      .form-actions
        button(type="submit") Iniciar sesión
        a(href="/forgot-password" class="forgot-password") ¿Olvidaste tu contraseña?

    .login-footer
      p ¿No tienes cuenta? 
        a(href="/register") Regístrate aquí

    script.
      document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Validate form using the validation.js rules
        if (!validateForm('login-form', loginRules)) {
          return;
        }
        
        // Show loading indicator
        showLoading();
        
        const formData = {
          email: document.getElementById('email').value,
          password: document.getElementById('password').value
        };

        try {
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
          });

          const data = await response.json();
          
          // Hide loading indicator
          hideLoading();

          if (response.ok) {
            if (data.user.role === 'admin') {
              window.location.href = '/inventory';
            } else if (data.user.role === 'staff') {
              window.location.href = '/inventory';
            } else {
              window.location.href = '/products';
            }
          } else {
            showMessage(data.message || data.error || 'Error al iniciar sesión', 'error');
          }
        } catch (error) {
          // Hide loading indicator
          hideLoading();
          
          showMessage('Error de conexión. Por favor, inténtelo de nuevo.', 'error');
        }
      });